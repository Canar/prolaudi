#!/usr/bin/env swipl
% vim: ft=prolog:noet:ts=4:sw=4
:-	initialization(main,main)
,	use_module(library(protobufs))
,	use_module(library(yall))
,	set_stream(user_output,type(binary))
,	set_prolog_flag(stack_limit, 2_147_483_648).

rate(44100).
key(100).
notelen(1r16).
%key(432).

%signal/3 - handles Len calculation
%signal([],_,_).
signal(S,Freq,Len):-
	rate(Rate),
	Samples is truncate(Rate*Len),
	signal(S,0,Samples,Freq).

%signal/4 - samples
signal([],Si,Sa,_):-Si >= Sa,!.
signal([Sample|T],SIndex,Samples,Freq):-
	rate(Rate),
	key(Key),
	Sample is sin( Freq * Key * SIndex / Rate *pi*2),
	SIndexN is SIndex+1,
	signal(T,SIndexN,Samples,Freq).

timetone(Time,Tone,L,[Tone,M]):-
    number(L),
	number(M),
	number(Tone),
    Time is L * M.

timetone(Time,Tone,Time,Tone):- %tone info only
	number(Time),
	number(Tone).

%signals/3 - sequence frequencies
%signals([],[],_).
%signals(S,[H|T],L):-
%	timetone(Time,Tone,L,H),
%	signal(Sa,Tone,Time),
%	append(Sa,Sb,S),
%	signals(Sb,T,L).

signals(S,T):-
	maplist([Sm,Tm]>>(
		notelen(L),
		timetone(Time,Tone,L,Tm),
		signal(Sm,Tone,Time)
	),Sz,T),
	append(Sz,S).
%signals(S,[H|T],L):-
%	signal(Sa,H,L),
%	append(Sa,Sb,S),
%	signals(Sb,T,L).
/*
 *
 */

modality([0,+2,+2,+1,+2,+2,+2,+1]).

%octave scale twelve-tet
ost(maj,[0,4,7]).
ost(min,[0,3,7]).
ost(maj7,[0,4,7,11]).

ost(ionian,    [0,2,4,5,7,9,11]).
ost(dorian,    [0,2,3,5,7,9,10]).
ost(phrygian,  [0,1,3,5,7,8,10]).
ost(lydian,    [0,2,4,6,7,9,11]).
ost(mixolydian,[0,2,4,5,7,9,10]).
ost(aeolian,   [0,2,3,5,7,8,10]).
ost(locrian,   [0,1,3,5,6,8,10]).

ost(jesuslovesme, [0,2,4,7,9]). % jesus loves me scale (pentatonic!)

hinhout(Hin,Hout):-
	Hout is 2 ** (Hin / 12).

%ost frequency map
ostfm([[Hout,L]|Tout],[[Hin,L]|Tin]):-
	hinhout(Hin,Hout),
	ostfm(Tout,Tin).
ostfm([Hout|Tout],[Hin|Tin]):-
	hinhout(Hin,Hout),
	ostfm(Tout,Tin).
ostfm([],[]).
	
note0(Chromatic,Scaled,Ost):-
	ost(Ost,O),
	length(O,Ostlen),
	Octave is div(Scaled,Ostlen),
	Offset is mod(Scaled,Ostlen),
	nth0(Offset,O,Ostval),
	Chromatic is Octave*12 + Ostval.
	
note1([Chromatic,L],[Scaled,L],Ost):-
	note1(Chromatic,Scaled,Ost).
note1(Chromatic,sharp(Scaled),Ost):-
	note0(Ca,Scaled,Ost),
	Chromatic is Ca + 1.
note1(Chromatic,flat(Scaled),Ost):-
	note0(Ca,Scaled,Ost),
	Chromatic is Ca - 1.
note1(Chromatic,Scaled,Ost):-
	note0(Chromatic,Scaled,Ost).
%Freqs,Notes,Ost
notes([[Hf,L]|Tf],[[Hn,L]|Tn],Ost):-
	note0(Hf,Hn,Ost),
	notes(Tf,Tn,Ost).
notes([Hf|Tf],[flat(Hn)|Tn],Ost):-
	note0(Hfa,Hn,Ost),
	Hf is Hfa - 1,
	notes(Tf,Tn,Ost).
notes([Hf|Tf],[sharp(Hn)|Tn],Ost):-
	note0(Hfa,Hn,Ost),
	Hf is Hfa + 1,
	notes(Tf,Tn,Ost).
notes([Hf|Tf],[Hn|Tn],Ost):-
	note0(Hf,Hn,Ost),
	notes(Tf,Tn,Ost).
notes([],[],_).

pnotes(_,[],[]).
%pnotes(Ost,[Hf|Tf],[Hn|Tn]):-
	

%pfs([]).
%pfs([H|T]):-
%	protobufs:float32_codes(H,C),
%	maplist(put_byte(user_output),C),
%	pfs(T).

pfs(S):-
	maplist([Sm,Cm]>>(
		protobufs:float32_codes(Sm,Cm)
	),S,C),
	maplist(
		maplist(put_byte(user_output))
	,C).

tune(jesuslovesme,[ %scaled, timed
3,2,2,1,2,3,[3,2],
4,4,5,4,4,3,[3,2],
3,2,2,1,2,3,[3,2],
4,4,3,0,2,1,[0,2],

[3,2],2,3,4,[5,3],
[3,2],2,0,2,[5,1/2],[4,1/2],[1,1/2],[2,1/2],
%[3,2],2,0,2,[1,3],
[3,2],2,3,4,[5,2],4,
3,0,2,1,[0,3]
]).

tune(holyholyholy_a,[
[5,7,9,12],
[5,7,9,12],
[3,5,12,14],
[3,5,12,14],
[[2,2],6,11,[16,2]]

]).
%

tune(holyholyholy_x,[ %phrygian?

%holy holy
5,7,9,[12,5],
5,7,9,[12,5],
3,5,12,[14,5],
3,5,12,[14,5],

2,6,11,[16,5],
%2,8,13,[16,5],
2,8,[13,6],
5,7,12,[16,5],
5,9,[11,6],

1,8,10,[17,5],
1,9,11,17,
1,9,11,17,
8,10,12,[17,5],
8,11,13,[17,5],

5,11,14,[16,5],
5,9,14,[16,5],
[5,2],[9,2],[12,2],[14,10],

% ]).
%tune(x,[

%early in the morn
4,11,13,[16,5],
4,11,13,16,
4,11,13,16,
4,12,14,[16,5],
4,11,13,[16,5],

3,7,12,[19,5],
3,sharp(8),13,[19,5],
4,9,13,[18,5],
5,9,14,[16,5],

6,11,[13,6],
6,9,11,[16,5],
6,sharp(8),12,[17,5],
6,sharp(8),12,17,
2,9,11,16,

2,9,11,16,
2,9,11,16,
2,9,11,16,
2,9,11,16,

2,8,11,16,
2,8,11,16,
2,8,11,16,
2,8,11,16,

%2nd loop - holyholyholy

5,7,9,[12,5],
5,7,9,[12,5],
3,5,12,[14,5],
3,5,12,[14,5],

2,6,11,[16,5],
2,8,13,[16,5],
5,7,12,[16,5],
5,9,[11,6],

1,8,10,[17,5],
1,9,11,17,
1,9,11,17,
8,10,12,[17,5],
8,11,13,[17,5],

5,11,14,[16,5],
5,9,14,[16,5],
[5,2],[9,2],[12,2],[16,10],


%god in three
[3,2],7,8,[12,2],[19,10],
0,9,12,[16,5],
0,flat(11),12,[16,5],

[1,2],[10,2],[12,2],[17,10],
[5,2],[9,2],12,flat(11),[14,10],

1,8,11,[15,5],
1,8,11,[13,5],
2,9,11,[13,5],
2,9,11,13,
5,12,8,12,

5,8,12,12,8,5,
5,8,12,12,8,5,
5,8,12,12,8,5,
5,8,12,12,8,5,
5,8,12,12,8,5,
5,8,12,12,8,5

]).

tune(hhh,[12,12,14,14,16,16]).
%
main(_):-
	Len is 10.0,
	get_time(StartTime),

	%tune(jesuslovesme,Tune),
	%notes(N,Tune,jesuslovesme),
	%tune(x,Tune),
	tune(holyholyholy_x,Tune),
	notes(N,Tune,phrygian),
	%notes(N,Tune,phrygian),
	ostfm(F,N),
	%signals(S,F,1r16),
	signals(S,F),
	
	%protobufs:float32_codes(H,C),
	%maplist(put_byte(user_output),C),
	%pfs(T).
	
	%[S]>>(
	%	maplist([Sm,Cm]>>(protobufs:float32_codes(Sm,Cm)),S,C),
	%	maplist(maplist(put_byte(user_output)),C)
	%)(S),
	pfs(S),
	
	get_time(EndTime),
	TakenTime is EndTime-StartTime,
	Rate is Len / TakenTime,
	write(user_error,'Time taken: '),
	writeln(user_error,TakenTime),
	write(user_error,'Rate: '),
	writeln(user_error,Rate).
